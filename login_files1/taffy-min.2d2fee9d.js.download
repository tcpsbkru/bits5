var TAFFY,exports,T;!function(){"use strict";var t,e,n,r,i,s,o,u,c,a,l,f,h,g,F,p,d,A,v,y,_,m,x,Y;if(!TAFFY)for(i="2.7",s=1,o="000000",u=1e3,c={},Y=function(t){var e=Array.prototype.slice.call(t);return e.sort()},a=function(t){return TAFFY.isArray(t)||TAFFY.isObject(t)?t:JSON.parse(t)},v=function(t,e){return y(t,function(t){return e.indexOf(t)>=0})},y=function(t,e,n){var r=[];return null==t?r:Array.prototype.filter&&t.filter===Array.prototype.filter?t.filter(e,n):(l(t,function(t,i,s){e.call(n,t,i,s)&&(r[r.length]=t)}),r)},x=function(t){return"[object RegExp]"===Object.prototype.toString.call(t)},m=function(t){var e=T.isArray(t)?[]:T.isObject(t)?{}:null;if(null===t)return t;for(var n in t)e[n]=x(t[n])?t[n].toString():T.isArray(t[n])||T.isObject(t[n])?m(t[n]):t[n];return e},_=function(t){var e=JSON.stringify(t);return null===e.match(/regex/)?e:JSON.stringify(m(t))},l=function(t,e,n){var r,i,s,o;if(t&&(T.isArray(t)&&1===t.length||!T.isArray(t)))e(T.isArray(t)?t[0]:t,0);else for(s=0,t=T.isArray(t)?t:[t],o=t.length;o>s&&(i=t[s],T.isUndefined(i)&&!n||(r=e(i,s),r!==T.EXIT));s++);},f=function(t,e){var n,r,i=0;for(r in t)if(t.hasOwnProperty(r)&&(n=e(t[r],r,i++),n===T.EXIT))break},c.extend=function(t,e){c[t]=function(){return e.apply(this,Y(arguments))}},h=function(t){var e;return!(!T.isString(t)||!/[t][0-9]*[r][0-9]*/i.test(t))||(!!(T.isObject(t)&&t.___id&&t.___s)||!!T.isArray(t)&&(e=!0,l(t,function(t){return h(t)?void 0:(e=!1,TAFFY.EXIT)}),e))},F=function(t,e){var n=!0;return l(e,function(e){switch(T.typeOf(e)){case"function":if(!e.apply(t))return n=!1,TAFFY.EXIT;break;case"array":n=1===e.length?F(t,e[0]):2===e.length?F(t,e[0])||F(t,e[1]):3===e.length?F(t,e[0])||F(t,e[1])||F(t,e[2]):4===e.length&&(F(t,e[0])||F(t,e[1])||F(t,e[2])||F(t,e[3])),e.length>4&&l(e,function(e){F(t,e)&&(n=!0)})}}),n},g=function(t){var e=[];return T.isString(t)&&/[t][0-9]*[r][0-9]*/i.test(t)&&(t={___id:t}),T.isArray(t)?(l(t,function(t){e.push(g(t))}),t=function(){var t=this,n=!1;return l(e,function(e){F(t,e)&&(n=!0)}),n}):T.isObject(t)?(T.isObject(t)&&t.___id&&t.___s&&(t={___id:t.___id}),f(t,function(t,n){T.isObject(t)||(t={is:t}),f(t,function(t,r){var i,s=[];i="hasAll"===r?function(t,e){e(t)}:l,i(t,function(t){var e,i=!0;e=function(){var e,s=this[n],o="==",u="!=",c="===",a="<",l=">",f="<=",h=">=",g="!==";return"undefined"!=typeof s&&(0===r.indexOf("!")&&r!==u&&r!==g&&(i=!1,r=r.substring(1,r.length)),e="regex"===r?t.test(s):"lt"===r||r===a?t>s:"gt"===r||r===l?s>t:"lte"===r||r===f?t>=s:"gte"===r||r===h?s>=t:"left"===r?0===s.indexOf(t):"leftnocase"===r?0===s.toLowerCase().indexOf(t.toLowerCase()):"right"===r?s.substring(s.length-t.length)===t:"rightnocase"===r?s.toLowerCase().substring(s.length-t.length)===t.toLowerCase():"like"===r?s.indexOf(t)>=0:"likenocase"===r?s.toLowerCase().indexOf(t.toLowerCase())>=0:r===c||"is"===r?s===t:r===o?s==t:r===g?s!==t:r===u?s!=t:"isnocase"===r?s.toLowerCase?s.toLowerCase()===t.toLowerCase():s===t:"has"===r?T.has(s,t):"hasall"===r?T.hasAll(s,t):"contains"===r?TAFFY.isArray(s)&&s.indexOf(t)>-1:-1!==r.indexOf("is")||TAFFY.isNull(s)||TAFFY.isUndefined(s)||TAFFY.isObject(t)||TAFFY.isArray(t)?T[r]&&T.isFunction(T[r])&&0===r.indexOf("is")?T[r](s)===t:!(!T[r]||!T.isFunction(T[r]))&&T[r](s,t):t===s[r],e=!(e&&!i)&&(!e&&!i||e))},s.push(e)}),e.push(1===s.length?s[0]:function(){var t=this,e=!1;return l(s,function(n){n.apply(t)&&(e=!0)}),e})})}),t=function(){var t=this,n=!0;return n=!(1===e.length&&!e[0].apply(t)||!(2!==e.length||e[0].apply(t)&&e[1].apply(t))||!(3!==e.length||e[0].apply(t)&&e[1].apply(t)&&e[2].apply(t))||!(4!==e.length||e[0].apply(t)&&e[1].apply(t)&&e[2].apply(t)&&e[3].apply(t))),e.length>4&&l(e,function(e){F(t,e)||(n=!1)}),n}):T.isFunction(t)?t:void 0},d=function(t,e){var n=function(t,n){var r=0;return T.each(e,function(e){var i,s,o,u,c;if(i=e.split(" "),s=i[0],o=1===i.length?"logical":i[1],"logical"===o)u=p(t[s]),c=p(n[s]),T.each(u.length<=c.length?u:c,function(t,e){return u[e]<c[e]?(r=-1,TAFFY.EXIT):u[e]>c[e]?(r=1,TAFFY.EXIT):void 0});else if("logicaldesc"===o)u=p(t[s]),c=p(n[s]),T.each(u.length<=c.length?u:c,function(t,e){return u[e]>c[e]?(r=-1,TAFFY.EXIT):u[e]<c[e]?(r=1,TAFFY.EXIT):void 0});else{if("asec"===o&&t[s]<n[s])return r=-1,T.EXIT;if("asec"===o&&t[s]>n[s])return r=1,T.EXIT;if("desc"===o&&t[s]>n[s])return r=-1,T.EXIT;if("desc"===o&&t[s]<n[s])return r=1,T.EXIT}return 0===r&&"logical"===o&&u.length<c.length?r=-1:0===r&&"logical"===o&&u.length>c.length?r=1:0===r&&"logicaldesc"===o&&u.length>c.length?r=-1:0===r&&"logicaldesc"===o&&u.length<c.length&&(r=1),0!==r?T.EXIT:void 0}),r};return t&&t.push?t.sort(n):t},function(){var t={},e=0;p=function(n){return e>u&&(t={},e=0),t["_"+n]||function(){var r,i,s,o=String(n),u=[],c="_",a="";for(r=0,i=o.length;i>r;r++)s=o.charCodeAt(r),s>=48&&57>=s||46===s?("n"!==a&&(a="n",u.push(c.toLowerCase()),c=""),c+=o.charAt(r)):("s"!==a&&(a="s",u.push(parseFloat(c)),c=""),c+=o.charAt(r));return u.push("n"===a?parseFloat(c):c.toLowerCase()),u.shift(),t["_"+n]=u,e++,u}()}}(),A=function(){this.context({results:this.getDBI().query(this.context())})},c.extend("filter",function(){var t=TAFFY.mergeObj(this.context(),{run:null}),e=[];return l(t.q,function(t){e.push(t)}),t.q=e,l(Y(arguments),function(e){t.q.push(g(e)),t.filterRaw.push(e)}),this.getroot(t)}),c.extend("order",function(t){t=t.split(",");var e,n=[];return l(t,function(t){n.push(t.replace(/^\s*/,"").replace(/\s*$/,""))}),e=TAFFY.mergeObj(this.context(),{sort:null}),e.order=n,this.getroot(e)}),c.extend("limit",function(t){var e,n=TAFFY.mergeObj(this.context(),{});return n.limit=t,n.run&&n.sort&&(e=[],l(n.results,function(n,r){return r+1>t?TAFFY.EXIT:void e.push(n)}),n.results=e),this.getroot(n)}),c.extend("start",function(t){var e,n=TAFFY.mergeObj(this.context(),{});return n.start=t,n.run&&n.sort&&!n.limit?(e=[],l(n.results,function(n,r){r+1>t&&e.push(n)}),n.results=e):n=TAFFY.mergeObj(this.context(),{run:null,start:t}),this.getroot(n)}),c.extend("update",function(t,e,n){var r,i=!0,s={},o=Y(arguments);return!TAFFY.isString(t)||2!==arguments.length&&3!==arguments.length?(s=t,2===o.length&&(i=e)):(s[t]=e,3===arguments.length&&(i=n)),r=this,A.call(this),l(this.context().results,function(t){var e=s;TAFFY.isFunction(e)?e=e.apply(TAFFY.mergeObj(t,{})):T.isFunction(e)&&(e=e(TAFFY.mergeObj(t,{}))),TAFFY.isObject(e)&&r.getDBI().update(t.___id,e,i)}),this.context().results.length&&this.context({run:null}),this}),c.extend("remove",function(t){var e=this,n=0;return A.call(this),l(this.context().results,function(t){e.getDBI().remove(t.___id),n++}),this.context().results.length&&(this.context({run:null}),e.getDBI().removeCommit(t)),n}),c.extend("count",function(){return A.call(this),this.context().results.length}),c.extend("callback",function(t,e){if(t){var n=this;setTimeout(function(){A.call(n),t.call(n.getroot(n.context()))},e||0)}return null}),c.extend("get",function(){return A.call(this),this.context().results}),c.extend("stringify",function(){return JSON.stringify(this.get())}),c.extend("first",function(){return A.call(this),this.context().results[0]||!1}),c.extend("last",function(){return A.call(this),this.context().results[this.context().results.length-1]||!1}),c.extend("sum",function(){var t=0,e=this;return A.call(e),l(Y(arguments),function(n){l(e.context().results,function(e){t+=e[n]||0})}),t}),c.extend("min",function(t){var e=null;return A.call(this),l(this.context().results,function(n){(null===e||n[t]<e)&&(e=n[t])}),e}),function(){var t=function(){var t,e,n;return t=function(t,e,n){var r,i,s;switch(2===n.length?(r=t[n[0]],s="===",i=e[n[1]]):(r=t[n[0]],s=n[1],i=e[n[2]]),s){case"===":return r===i;case"!==":return r!==i;case"<":return i>r;case">":return r>i;case"<=":return i>=r;case">=":return r>=i;case"==":return r==i;case"!=":return r!=i;default:throw String(s)+" is not supported"}},e=function(t,e){var n,r,i={};for(n in t)t.hasOwnProperty(n)&&(i[n]=t[n]);for(n in e)e.hasOwnProperty(n)&&"___id"!==n&&"___s"!==n&&(r=TAFFY.isUndefined(i[n])?"":"right_",i[r+String(n)]=e[n]);return i},n=function(n){var r,i,s=Y(arguments),o=s.length,u=[];if("function"!=typeof n.filter){if(!n.TAFFY)throw"TAFFY DB or result not supplied";r=n()}else r=n;return this.context({results:this.getDBI().query(this.context())}),TAFFY.each(this.context().results,function(n){r.each(function(r){var c,a=!0;for(i=1;o>i&&(c=s[i],a="function"==typeof c?c(n,r):!("object"!=typeof c||!c.length)&&t(n,r,c));i++);a&&u.push(e(n,r))})}),TAFFY(u)()}}();c.extend("join",t)}(),c.extend("max",function(t){var e=null;return A.call(this),l(this.context().results,function(n){(null===e||n[t]>e)&&(e=n[t])}),e}),c.extend("select",function(){var t=[],e=Y(arguments);return A.call(this),1===arguments.length?l(this.context().results,function(n){t.push(n[e[0]])}):l(this.context().results,function(n){var r=[];l(e,function(t){r.push(n[t])}),t.push(r)}),t}),c.extend("distinct",function(){var t=[],e=Y(arguments);return A.call(this),1===arguments.length?l(this.context().results,function(n){var r=n[e[0]],i=!1;l(t,function(t){return r===t?(i=!0,TAFFY.EXIT):void 0}),i||t.push(r)}):l(this.context().results,function(n){var r=[],i=!1;l(e,function(t){r.push(n[t])}),l(t,function(t){var n=!0;return l(e,function(e,i){return r[i]!==t[i]?(n=!1,TAFFY.EXIT):void 0}),n?(i=!0,TAFFY.EXIT):void 0}),i||t.push(r)}),t}),c.extend("supplant",function(t,e){var n=[];return A.call(this),l(this.context().results,function(e){n.push(t.replace(/\{([^\{\}]*)\}/g,function(t,n){var r=e[n];return"string"==typeof r||"number"==typeof r?r:t}))}),e?n:n.join("")}),c.extend("each",function(t){return A.call(this),l(this.context().results,t),this}),c.extend("map",function(t){var e=[];return A.call(this),l(this.context().results,function(n){e.push(t(n))}),e}),T=function(t){var e,n,r,i=[],u={},p=1,A={template:!1,onInsert:!1,onUpdate:!1,onRemove:!1,onDBChange:!1,storageName:!1,forcePropertyCase:null,cacheSize:100,name:""},v=new Date,y=0,m=0,x={};return n=function(t){var e=[],r=!1;return 0===t.length?i:(l(t,function(t){T.isString(t)&&/[t][0-9]*[r][0-9]*/i.test(t)&&i[u[t]]&&(e.push(i[u[t]]),r=!0),T.isObject(t)&&t.___id&&t.___s&&i[u[t.___id]]&&(e.push(i[u[t.___id]]),r=!0),T.isArray(t)&&l(t,function(t){l(n(t),function(t){e.push(t)})})}),r&&e.length>1&&(e=[]),e)},e={dm:function(t){return t&&(v=t,x={},y=0,m=0),A.onDBChange&&setTimeout(function(){A.onDBChange.call(i)},0),A.storageName&&setTimeout(function(){localStorage.setItem("taffy_"+A.storageName,JSON.stringify(i))}),v},insert:function(t,n){var c=[],h=[],g=a(t);return l(g,function(t,r){var a,g;return T.isArray(t)&&0===r?(l(t,function(t){c.push("lower"===A.forcePropertyCase?t.toLowerCase():"upper"===A.forcePropertyCase?t.toUpperCase():t)}),!0):(T.isArray(t)?(a={},l(t,function(t,e){a[c[e]]=t}),t=a):T.isObject(t)&&A.forcePropertyCase&&(g={},f(t,function(e,n){g["lower"===A.forcePropertyCase?n.toLowerCase():"upper"===A.forcePropertyCase?n.toUpperCase():n]=t[n]}),t=g),p++,t.___id="T"+String(o+s).slice(-6)+"R"+String(o+p).slice(-6),t.___s=!0,h.push(t.___id),A.template&&(t=T.mergeObj(A.template,t)),i.push(t),u[t.___id]=i.length-1,A.onInsert&&(n||TAFFY.isUndefined(n))&&A.onInsert.call(t),void e.dm(new Date))}),r(h)},sort:function(t){return i=d(i,t.split(",")),u={},l(i,function(t,e){u[t.___id]=e}),e.dm(new Date),!0},update:function(t,n,r){var s,o,c,a,l={};A.forcePropertyCase&&(f(n,function(t,e){l["lower"===A.forcePropertyCase?e.toLowerCase():"upper"===A.forcePropertyCase?e.toUpperCase():e]=t}),n=l),s=i[u[t]],o=T.mergeObj(s,n),c={},a=!1,f(o,function(t,e){(TAFFY.isUndefined(s[e])||s[e]!==t)&&(c[e]=t,a=!0)}),a&&(A.onUpdate&&(r||TAFFY.isUndefined(r))&&A.onUpdate.call(o,i[u[t]],c),i[u[t]]=o,e.dm(new Date))},remove:function(t){i[u[t]].___s=!1},removeCommit:function(t){var n;for(n=i.length-1;n>-1;n--)i[n].___s||(A.onRemove&&(t||TAFFY.isUndefined(t))&&A.onRemove.call(i[n]),u[i[n].___id]=void 0,i.splice(n,1));u={},l(i,function(t,e){u[t.___id]=e}),e.dm(new Date)},query:function(t){var r,s,o,u,c,a;if(A.cacheSize&&(s="",l(t.filterRaw,function(t){return T.isFunction(t)?(s="nocache",TAFFY.EXIT):void 0}),""===s&&(s=_(T.mergeObj(t,{q:!1,run:!1,sort:!1})))),!t.results||!t.run||t.run&&e.dm()>t.run){if(o=[],A.cacheSize&&x[s])return x[s].i=y++,x[s].results;0===t.q.length&&0===t.index.length?(l(i,function(t){o.push(t)}),r=o):(u=n(t.index),l(u,function(e){(0===t.q.length||F(e,t.q))&&o.push(e)}),r=o)}else r=t.results;return!(t.order.length>0)||t.run&&t.sort||(r=d(r,t.order)),r.length&&(t.limit&&t.limit<r.length||t.start)&&(c=[],l(r,function(e,n){if(!t.start||t.start&&n+1>=t.start)if(t.limit){if(a=t.start?n+1-t.start:n,a<t.limit)c.push(e);else if(a>t.limit)return TAFFY.EXIT}else c.push(e)}),r=c),A.cacheSize&&"nocache"!==s&&(m++,setTimeout(function(){var t,e;m>=2*A.cacheSize&&(m=0,t=y-A.cacheSize,e={},f(function(n,r){n.i>=t&&(e[r]=n)}),x=e)},0),x[s]={i:y++,results:r}),r}},r=function(){var t,n;return t=TAFFY.mergeObj(TAFFY.mergeObj(c,{insert:void 0}),{getDBI:function(){return e},getroot:function(t){return r.call(t)},context:function(t){return t&&(n=TAFFY.mergeObj(n,t.hasOwnProperty("results")?TAFFY.mergeObj(t,{run:new Date,sort:new Date}):t)),n},extend:void 0}),n=this&&this.q?this:{limit:!1,start:!1,q:[],filterRaw:[],index:[],order:[],results:!1,run:null,sort:null,settings:A},l(Y(arguments),function(t){h(t)?n.index.push(t):n.q.push(g(t)),n.filterRaw.push(t)}),t},s++,t&&e.insert(t),r.insert=e.insert,r.merge=function(t,n,i){var s={},o=[],u={};return i=i||!1,n=n||"id",l(t,function(t){var u;s[n]=t[n],o.push(t[n]),u=r(s).first(),u?e.update(u.___id,t,i):e.insert(t,i)}),u[n]=o,r(u)},r.TAFFY=!0,r.sort=e.sort,r.settings=function(t){return t&&(A=TAFFY.mergeObj(A,t),t.template&&r().update(t.template)),A},r.store=function(t){var e,n=!1;return localStorage&&(t&&(e=localStorage.getItem("taffy_"+t),e&&e.length>0&&(r.insert(e),n=!0),i.length>0&&setTimeout(function(){localStorage.setItem("taffy_"+A.storageName,JSON.stringify(i))})),r.settings({storageName:t})),r},r},TAFFY=T,T.each=l,T.eachin=f,T.extend=c.extend,TAFFY.EXIT="TAFFYEXIT",TAFFY.mergeObj=function(t,e){var n={};return f(t,function(e,r){n[r]=t[r]}),f(e,function(t,r){n[r]=e[r]}),n},TAFFY.has=function(t,e){var n,r=!1;if(t.TAFFY)return r=t(e),r.length>0;switch(T.typeOf(t)){case"object":if(T.isObject(e))f(e,function(n,i){return r!==!0||T.isUndefined(t[i])||!t.hasOwnProperty(i)?(r=!1,TAFFY.EXIT):void(r=T.has(t[i],e[i]))});else if(T.isArray(e))l(e,function(n,i){return r=T.has(t,e[i]),r?TAFFY.EXIT:void 0});else if(T.isString(e))return!TAFFY.isUndefined(t[e]);return r;case"array":if(T.isObject(e))l(t,function(n,i){return r=T.has(t[i],e),r===!0?TAFFY.EXIT:void 0});else if(T.isArray(e))l(e,function(n,i){return l(t,function(n,s){return r=T.has(t[s],e[i]),r===!0?TAFFY.EXIT:void 0}),r===!0?TAFFY.EXIT:void 0});else if(T.isString(e)||T.isNumber(e))for(r=!1,n=0;n<t.length;n++)if(r=T.has(t[n],e))return!0;return r;case"string":if(T.isString(e)&&e===t)return!0;break;default:if(T.typeOf(t)===T.typeOf(e)&&t===e)return!0}return!1},TAFFY.hasAll=function(t,e){var n,r=TAFFY;return r.isArray(e)?(n=!0,l(e,function(e){return n=r.has(t,e),n===!1?TAFFY.EXIT:void 0}),n):r.has(t,e)},TAFFY.typeOf=function(t){var e=typeof t;return"object"===e&&(t?"number"!=typeof t.length||t.propertyIsEnumerable("length")||(e="array"):e="null"),e},TAFFY.getObjectKeys=function(t){var e=[];return f(t,function(t,n){e.push(n)}),e.sort(),e},TAFFY.isSameArray=function(t,e){return!(!TAFFY.isArray(t)||!TAFFY.isArray(e)||t.join(",")!==e.join(","))},TAFFY.isSameObject=function(t,e){var n=TAFFY,r=!0;return n.isObject(t)&&n.isObject(e)&&n.isSameArray(n.getObjectKeys(t),n.getObjectKeys(e))?f(t,function(i,s){return n.isObject(t[s])&&n.isObject(e[s])&&n.isSameObject(t[s],e[s])||n.isArray(t[s])&&n.isArray(e[s])&&n.isSameArray(t[s],e[s])||t[s]===e[s]?void 0:(r=!1,TAFFY.EXIT)}):r=!1,r},t=["String","Number","Object","Array","Boolean","Null","Function","Undefined"],e=function(t){return function(e){return TAFFY.typeOf(e)===t.toLowerCase()}},n=0;n<t.length;n++)r=t[n],TAFFY["is"+r]=e(r)}(),"object"==typeof exports&&(exports.taffy=TAFFY);